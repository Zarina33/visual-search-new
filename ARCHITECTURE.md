# ğŸ—ï¸ ĞĞ Ğ¥Ğ˜Ğ¢Ğ•ĞšĞ¢Ğ£Ğ Ğ VISUAL SEARCH PROJECT

## ğŸ“Š ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ĞšĞ›Ğ˜Ğ•ĞĞ¢                                   â”‚
â”‚  (Web App / Mobile App / API Consumer)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP/HTTPS
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         NGINX                                    â”‚
â”‚  - Reverse Proxy (API: /api/*)                                  â”‚
â”‚  - Static Files (Images: /images/*)                             â”‚
â”‚  - SSL Termination                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                           â”‚
             â”‚ /api/*                    â”‚ /images/*
             â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    FASTAPI APP         â”‚    â”‚  LOCAL STORAGE           â”‚
â”‚  (Port 8008)           â”‚    â”‚  ~/product-images/       â”‚
â”‚                        â”‚    â”‚  â”œâ”€â”€ {product_id}/       â”‚
â”‚  Routes:               â”‚    â”‚  â”‚   â””â”€â”€ image_*.jpg     â”‚
â”‚  - /api/v1/search      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  - /api/v1/products    â”‚
â”‚  - /api/v1/health      â”‚
â”‚  - /docs               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚      â”‚        â”‚
     â”‚      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚      â”‚                           â”‚
     â–¼      â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚  â”‚   Qdrant     â”‚  â”‚    Redis     â”‚
â”‚ (Port 5434) â”‚  â”‚ (Port 6333)  â”‚  â”‚ (Port 6380)  â”‚
â”‚             â”‚  â”‚              â”‚  â”‚              â”‚
â”‚ Products:   â”‚  â”‚ Vectors:     â”‚  â”‚ Celery:      â”‚
â”‚ - id        â”‚  â”‚ - embeddings â”‚  â”‚ - broker     â”‚
â”‚ - title     â”‚  â”‚ - metadata   â”‚  â”‚ - results    â”‚
â”‚ - image_url â”‚  â”‚ - similarity â”‚  â”‚              â”‚
â”‚ - metadata  â”‚  â”‚   search     â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                â–²                    â–²
     â”‚                â”‚                    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   CLIP MODEL             â”‚
         â”‚   (openai/clip-vit-...)  â”‚
         â”‚                          â”‚
         â”‚   - Image â†’ Vector       â”‚
         â”‚   - Text â†’ Vector        â”‚
         â”‚   - GPU/CPU Processing   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ğ¡ĞšĞ Ğ˜ĞŸĞ¢: scripts/download_and_index_local.py                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  1. ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ¡ĞŸĞ˜Ğ¡ĞšĞ Ğ˜Ğ— S3     â”‚
          â”‚     - BakaiMarket S3 Bucket    â”‚
          â”‚     - ~201,596 Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  2. Ğ¡ĞšĞĞ§Ğ˜Ğ’ĞĞĞ˜Ğ• Ğ˜Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞ˜Ğ™     â”‚
          â”‚     - ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾ (5 Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²)  â”‚
          â”‚     - Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²             â”‚
          â”‚       ~/product-images/        â”‚
          â”‚     - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ (Ñ€Ğ°Ğ·Ğ¼ĞµÑ€,       â”‚
          â”‚       Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚, Ñ†ĞµĞ»Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ)     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  3. Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ­ĞœĞ‘Ğ•Ğ”Ğ”Ğ˜ĞĞ“ĞĞ’      â”‚
          â”‚     - CLIP Model               â”‚
          â”‚     - Batch processing         â”‚
          â”‚     - CPU/GPU                  â”‚
          â”‚     - 512-dim vectors          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  4. Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ• Ğ’ PostgreSQL    â”‚
          â”‚     - Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ             â”‚
          â”‚     - Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ URL            â”‚
          â”‚     - ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  5. Ğ˜ĞĞ”Ğ•ĞšĞ¡ĞĞ¦Ğ˜Ğ¯ Ğ’ Qdrant        â”‚
          â”‚     - Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ñ‹                  â”‚
          â”‚     - Payload                  â”‚
          â”‚     - Batch upsert             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ğ¿Ğ¾Ğ¸ÑĞºĞ°

### ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT         â”‚
â”‚  Upload Image   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: POST /api/v1/search/by-image  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ           â”‚
â”‚     - Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚                        â”‚
â”‚     - Ğ Ğ°Ğ·Ğ¼ĞµÑ€                        â”‚
â”‚     - Ğ¦ĞµĞ»Ğ¾ÑÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. CLIP: Image â†’ Vector            â”‚
â”‚     - Preprocessing                 â”‚
â”‚     - Encoding                      â”‚
â”‚     - Normalization                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Qdrant: Vector Search           â”‚
â”‚     - Cosine similarity             â”‚
â”‚     - Top-K results                 â”‚
â”‚     - Threshold filtering           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. PostgreSQL: Enrich Data         â”‚
â”‚     - Product details               â”‚
â”‚     - Image URLs                    â”‚
â”‚     - Metadata                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Response                        â”‚
â”‚     - Products list                 â”‚
â”‚     - Similarity scores             â”‚
â”‚     - Image URLs                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT         â”‚
â”‚  Search Query   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API: POST /api/v1/search/by-text   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. CLIP: Text â†’ Vector             â”‚
â”‚     - Tokenization                  â”‚
â”‚     - Encoding                      â”‚
â”‚     - Normalization                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Qdrant: Vector Search           â”‚
â”‚     - Cosine similarity             â”‚
â”‚     - Top-K results                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. PostgreSQL: Enrich Data         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Response                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### PostgreSQL: products

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    external_id VARCHAR(255) UNIQUE NOT NULL,  -- "bakai_{product_id}"
    title VARCHAR(500) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    price DECIMAL(10, 2),
    currency VARCHAR(10),
    image_url TEXT NOT NULL,                   -- "http://localhost/images/{id}/image.jpg"
    product_metadata JSONB,                    -- {"source": "s3", "local_path": "..."}
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_external_id ON products(external_id);
CREATE INDEX idx_category ON products(category);
```

### Qdrant: product_embeddings

```json
{
  "collection_name": "product_embeddings",
  "vector_size": 512,
  "distance": "Cosine",
  "points": [
    {
      "id": "bakai_12345",
      "vector": [0.123, -0.456, ...],  // 512 dimensions
      "payload": {
        "external_id": "bakai_12345",
        "original_id": "12345",
        "category": "bakai"
      }
    }
  ]
}
```

---

## ğŸ”§ ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. FastAPI Application (`app/`)

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ main.py              # FastAPI app, middleware
â”‚   â””â”€â”€ routes/
â”‚       â”œâ”€â”€ search.py        # ĞŸĞ¾Ğ¸ÑĞº (image/text)
â”‚       â”œâ”€â”€ products.py      # CRUD Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
â”‚       â”œâ”€â”€ health.py        # Health checks
â”‚       â”œâ”€â”€ metrics.py       # Prometheus metrics
â”‚       â””â”€â”€ webhooks.py      # Ğ’ĞµĞ±Ñ…ÑƒĞºĞ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ postgres.py          # SQLAlchemy models, CRUD
â”‚   â””â”€â”€ qdrant.py            # Qdrant client, vector ops
â”œâ”€â”€ models/
â”‚   â””â”€â”€ clip_model.py        # CLIP embedder
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ bakai_s3_client.py   # S3 client
â”‚   â”œâ”€â”€ image_processing.py  # Image utils
â”‚   â””â”€â”€ logger.py            # Logging
â”œâ”€â”€ workers/
â”‚   â”œâ”€â”€ celery_app.py        # Celery config
â”‚   â””â”€â”€ tasks.py             # Background tasks
â””â”€â”€ config.py                # Settings (Pydantic)
```

### 2. Docker Services

```yaml
services:
  postgres:
    image: postgres:15
    ports: ["5434:5432"]
    volumes: [postgres_data:/var/lib/postgresql/data]
    
  redis:
    image: redis:7-alpine
    ports: ["6380:6379"]
    
  qdrant:
    image: qdrant/qdrant:latest
    ports: ["6333:6333", "6334:6334"]
    volumes: [qdrant_data:/qdrant/storage]
```

### 3. CLIP Model

- **Model:** `openai/clip-vit-base-patch32`
- **Framework:** PyTorch
- **Input:** Image (PIL) or Text (str)
- **Output:** 512-dim vector (numpy array)
- **Device:** CPU or CUDA

### 4. Local Storage

```
~/product-images/
â”œâ”€â”€ 12345/
â”‚   â”œâ”€â”€ image_1.jpg
â”‚   â”œâ”€â”€ image_2.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 12346/
â”‚   â””â”€â”€ image_1.jpg
â””â”€â”€ ...
```

**URL Format:** `http://your-domain.com/images/{product_id}/image_1.jpg`

---

## ğŸš€ Deployment Flow

```
1. SERVER SETUP
   â”œâ”€â”€ Install: Python, Poetry, Docker, NVIDIA drivers
   â””â”€â”€ Clone repository

2. CONFIGURATION
   â”œâ”€â”€ Create .env from env_server.txt
   â””â”€â”€ Adjust ports if needed

3. DOCKER SERVICES
   â”œâ”€â”€ docker-compose up -d
   â””â”€â”€ Verify: docker-compose ps

4. DATABASE INIT
   â”œâ”€â”€ poetry run python scripts/init_databases.py
   â””â”€â”€ Verify: psql, curl qdrant

5. DATA LOADING
   â”œâ”€â”€ poetry run python scripts/download_and_index_local.py
   â””â”€â”€ Wait 6-12 hours for ~200K images

6. API START
   â”œâ”€â”€ Manual: poetry run uvicorn ...
   â””â”€â”€ Or systemd: systemctl start visual-search-api

7. NGINX SETUP
   â”œâ”€â”€ Configure reverse proxy
   â”œâ”€â”€ Configure static files
   â””â”€â”€ Enable SSL (optional)

8. MONITORING
   â”œâ”€â”€ Health checks
   â”œâ”€â”€ Logs
   â””â”€â”€ Metrics (optional: Prometheus)
```

---

## ğŸ“Š Performance Characteristics

### Throughput
- **Image Download:** ~20-50 images/sec (network dependent)
- **Embedding Generation:** 
  - CPU: ~5-10 images/sec
  - GPU: ~50-100 images/sec (batch)
- **Vector Search:** <100ms for top-20 results
- **API Response:** <200ms (cached embeddings)

### Storage
- **Images:** ~10-50 KB/image â†’ ~2-10 GB total
- **PostgreSQL:** ~1-2 KB/product â†’ ~10-20 MB
- **Qdrant:** ~2 KB/vector â†’ ~10-20 MB
- **Total:** ~3-11 GB

### Resources
- **RAM:** 4-8 GB (API + CLIP + Docker)
- **GPU VRAM:** 2-4 GB (CLIP model)
- **CPU:** 4+ cores recommended
- **Disk:** 20+ GB free space

---

## ğŸ” Security Considerations

1. **API Authentication** (TODO)
   - JWT tokens
   - API keys
   - Rate limiting

2. **Network Security**
   - Firewall (UFW)
   - SSL/TLS (Certbot)
   - Private Docker network

3. **Data Security**
   - PostgreSQL password
   - Redis password (optional)
   - S3 credentials in .env

4. **File Permissions**
   - Images: 644
   - Directories: 755
   - .env: 600

---

## ğŸ“ˆ Scaling Strategies

### Horizontal Scaling
- Multiple API instances (load balancer)
- Multiple Celery workers
- PostgreSQL read replicas
- Qdrant cluster

### Vertical Scaling
- More CPU cores â†’ faster embedding
- More RAM â†’ larger batches
- Better GPU â†’ faster CLIP
- SSD â†’ faster I/O

### Optimization
- CLIP batch size tuning
- Qdrant index optimization
- PostgreSQL query optimization
- Image CDN (CloudFlare, etc.)

---

## ğŸ”„ Maintenance Tasks

### Daily
- Monitor logs
- Check disk space
- Verify API health

### Weekly
- Review error logs
- Check database size
- Update dependencies (if needed)

### Monthly
- Backup databases
- Rotate logs
- Performance review

### As Needed
- Reindex Qdrant
- Update CLIP model
- Add new products
- Scale resources

---

**Version:** 1.0  
**Last Updated:** 25 Ğ½Ğ¾ÑĞ±Ñ€Ñ 2025


